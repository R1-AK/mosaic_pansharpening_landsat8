// Define the center point
var center = ee.Geometry.Point([112.7059683, -7.5244837]);

// Create a 3 km x 3 km rectangle around the center point
var rectangle = center.buffer(3000).bounds();

// Function to mask clouds using the quality band of Landsat 8
var maskL8 = function(image) {
  var qa = image.select('QA_PIXEL');
  // Check that the cloud bit is off
  var mask = qa.bitwiseAnd(1 << 3).eq(0); // Bit 3 for cloud
  return image.updateMask(mask);
};

// HSV-based Pan-Sharpening of Landsat 8 TOA images
var panSharpenL8 = function(image) {
  var rgb = image.select('B4', 'B3', 'B2');
  var pan = image.select('B8');
  // Convert to HSV, swap in the pan band, and convert back to RGB
  var huesat = rgb.rgbToHsv().select('hue', 'saturation');
  var upres = ee.Image.cat(huesat, pan).hsvToRgb();
  return image.addBands(upres.rename(['B4', 'B3', 'B2']));
};

// Function to filter, process, and create pansharpened mosaics for a given year
function getMosaic(year) {
  var startDate = ee.Date.fromYMD(year, 1, 1);
  var endDate = ee.Date.fromYMD(year, 12, 31);

  // Filter Landsat 8 Collection for the specified year and region
  var landsatCollection = ee.ImageCollection('LANDSAT/LC08/C02/T1_TOA')
    .filterBounds(rectangle)
    .filterDate(startDate, endDate)
    .filter(ee.Filter.lt('CLOUD_COVER', 20))
    .map(maskL8)
    .map(panSharpenL8); // Apply cloud masking and pansharpening

  // Create a mosaic
  var mosaic = landsatCollection.median().clip(rectangle);

  return mosaic;
}

// Years to process
var years = [2020, 2021, 2022, 2023];

// Iterate over each year, process, and display
years.forEach(function(year) {
  var mosaic = getMosaic(year);

  // Add the pansharpened mosaic to the map with a title for the year
  Map.addLayer(mosaic, {bands: ['B4', 'B3', 'B2'], min: 0, max: 0.3, gamma: 1.4}, 'Pansharpened Mosaic ' + year);

  // Export the pansharpened image to Google Drive
  Export.image.toDrive({
    image: mosaic.visualize({bands: ['B4', 'B3', 'B2'], min: 0, max: 0.3, gamma: 1.4}),
    description: 'Pansharpened_Landsat8_Mosaic_' + year,
    folder: 'Lapindo',
    fileNamePrefix: 'Pansharpened_Landsat8_Mosaic_' + year,
    region: rectangle,
    scale: 15, // Higher resolution for pansharpened
    crs: 'EPSG:4326'
  });
});

// Center the map on the rectangle
Map.centerObject(rectangle, 13);

// Add the rectangle to the map
Map.addLayer(rectangle, {color: 'red'}, 'Rectangle');
